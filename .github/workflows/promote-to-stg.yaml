name: Promote to STG

on:
  workflow_dispatch:
    inputs:
      dev_image_sha:
        description: 'DEV image SHA to promote (leave empty for latest)'
        required: false
        type: string
  push:
    tags:
      - 'v*.*.*'

jobs:
  retag-image:
    name: Pull DEV image and retag for STG
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    
    outputs:
      stg_image: ${{ steps.retag.outputs.stg_image }}
      image_digest: ${{ steps.retag.outputs.digest }}
      dev_image: ${{ steps.get-dev.outputs.dev_image }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine DEV image to promote
        id: get-dev
        run: |
          if [ -n "${{ inputs.dev_image_sha }}" ]; then
            # Manual workflow: use specified SHA
            DEV_SHA="${{ inputs.dev_image_sha }}"
          else
            # Tag workflow: use the tagged commit's SHA
            DEV_SHA=$(git rev-parse --short=7 ${GITHUB_REF#refs/tags/})
          fi
          
          DEV_IMAGE="ghcr.io/${{ github.repository }}/demo-app:${DEV_SHA}"
          echo "dev_image=${DEV_IMAGE}" >> $GITHUB_OUTPUT
          echo "dev_sha=${DEV_SHA}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Promoting DEV image: ${DEV_IMAGE}"

      - name: Verify DEV image exists and pull
        id: pull
        run: |
          DEV_IMAGE="${{ steps.get-dev.outputs.dev_image }}"
          
          # Check if image exists
          if ! docker manifest inspect "${DEV_IMAGE}" > /dev/null 2>&1; then
            echo "âŒ Error: DEV image not found: ${DEV_IMAGE}"
            echo "Make sure this commit was built and pushed to DEV"
            exit 1
          fi
          
          echo "âœ… DEV image found, pulling..."
          docker pull "${DEV_IMAGE}"
          
          # Get and verify digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "${DEV_IMAGE}" | cut -d'@' -f2)
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ Image digest: ${DIGEST}"

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Verify image signature (Cosign)
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          DEV_IMAGE="${{ steps.get-dev.outputs.dev_image }}"
          DIGEST="${{ steps.pull.outputs.digest }}"
          
          echo "ðŸ” Verifying image signature..."
          if ! cosign verify "${DEV_IMAGE}@${DIGEST}"; then
            echo "âš ï¸  Warning: Image signature verification failed"
            echo "This image may not have been properly signed in DEV"
            # Decide: exit 1 (strict) or continue (permissive)
            # exit 1
          fi
          echo "âœ… Signature verified"

      - name: Retag and push to STG
        id: retag
        run: |
          # Extract version from tag (v1.0.0 -> 1.0.0)
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          
          DEV_IMAGE="${{ steps.get-dev.outputs.dev_image }}"
          STG_IMAGE="ghcr.io/${{ github.repository }}/demo-app:${VERSION}"
          DIGEST="${{ steps.pull.outputs.digest }}"
          
          echo "ðŸ·ï¸  Retagging: ${DEV_IMAGE} â†’ ${STG_IMAGE}"
          docker tag "${DEV_IMAGE}" "${STG_IMAGE}"
          
          echo "â¬†ï¸  Pushing to registry..."
          docker push "${STG_IMAGE}"
          
          echo "stg_image=${STG_IMAGE}" >> $GITHUB_OUTPUT
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT
          echo "âœ… Successfully promoted to STG"

      - name: Sign STG image
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          echo "ðŸ” Signing STG image..."
          cosign sign --yes ${{ steps.retag.outputs.stg_image }}@${{ steps.retag.outputs.digest }}

      - name: Add additional tags
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          STG_IMAGE="ghcr.io/${{ github.repository }}/demo-app"
          
          # Tag with major.minor (e.g., 1.0)
          if [[ $VERSION =~ ^([0-9]+)\.([0-9]+)\. ]]; then
            MAJOR_MINOR="${BASH_REMATCH[1]}.${BASH_REMATCH[2]}"
            docker tag "${{ steps.retag.outputs.stg_image }}" "${STG_IMAGE}:${MAJOR_MINOR}"
            docker push "${STG_IMAGE}:${MAJOR_MINOR}"
            echo "Tagged as: ${MAJOR_MINOR}"
          fi

  update-stg:
    name: Update STG manifest
    needs: [retag-image]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/demo-gitops-repo
          token: ${{ secrets.GITOPS_PAT }}
          path: gitops

      - name: Update STG image tag
        run: |
          cd gitops/environments/stg
          
          IMAGE="${{ needs.retag-image.outputs.stg_image }}"
          
          echo "ðŸ“ Updating STG manifest to: $IMAGE"
          sed -i "s|image: ghcr.io/.*/demo-app:.*|image: ${IMAGE}|g" rollout.yaml
          
          echo "Updated rollout.yaml:"
          grep "image:" rollout.yaml
          
      - name: Commit and push
        run: |
          cd gitops
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          
          TAG_NAME=${GITHUB_REF#refs/tags/}
          DEV_SHA="${{ needs.retag-image.outputs.dev_image }}"
          
          git diff --staged --quiet || git commit -m "chore(stg): promote ${TAG_NAME}
          
          Promoted from DEV: ${DEV_SHA}
          Digest: ${{ needs.retag-image.outputs.image_digest }}"
          git push

      - name: Create promotion summary
        run: |
          echo "## ðŸš€ Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: STG" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: ${{ needs.retag-image.outputs.dev_image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target**: ${{ needs.retag-image.outputs.stg_image }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest**: \`${{ needs.retag-image.outputs.image_digest }}\`" >> $GITHUB_STEP_SUMMARY
